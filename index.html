<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>LAKSPICES LLC — Spice Store</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      margin: 20px;
    }
    h1 { margin-bottom: 20px; }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }
    .card {
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      background: #fafafa;
    }
    .card img {
      max-width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 6px;
    }
    .price {
      font-weight: 700;
      margin-top: 8px;
    }
    .notavail {
      color: #b00;
      font-weight: 700;
    }
    .cart {
      position: fixed;
      right: 20px;
      top: 20px;
      width: 280px;
      border: 1px solid #ddd;
      padding: 12px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .cart h3 { margin-top: 0; }
    .cart-item {
      font-size: 14px;
      margin-bottom: 6px;
    }
    .cart-item button {
      margin-left: 3px;
    }
    button {
      padding: 6px 10px;
      margin-top: 6px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #0070ba;
      color: #fff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background: #888;
    }
  </style>
</head>
<body>
  <h1>Welcome to LAKSPICES LLC</h1>
  <p>Premium spices like chilies, cardamom, pepper & more!</p>

  <div id="grid" class="grid"></div>

  <div class="cart" id="cartbox">
    <h3>Your Cart</h3>
    <div id="cartitems"></div>
    <div id="total"></div>
    <!-- PayPal Buttons appear here -->
    <div id="paypal-button-container"></div>
  </div>

  <!-- PayPal SDK (replace with your sandbox client ID while testing) -->
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&currency=USD"></script>

  <script>
    const perPage = 200;
    let products = [];
    const cart = [];

    async function load(){
      const res = await fetch(`/api/products?perPage=${perPage}`);
      const data = await res.json();
      products = data.products;
      renderGrid();
      renderCart();
    }

    function renderGrid(){
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      for(const p of products){
        const el = document.createElement('div'); 
        el.className='card';
        el.innerHTML = `
          <img src="${p.image_url||'https://via.placeholder.com/300x180?text=No+Image'}" alt="${p.name}">
          <h4>${p.name}</h4>
          <div>${p.description||''}</div>
          <div class="price">$${(p.price_cents/100).toFixed(2)}</div>
          <div>${p.stock>0? ('In stock: '+p.stock) : '<span class="notavail">Not available</span>'}</div>
          <button id="add-${p.id}" ${p.stock===0?'disabled':''}>Add to cart</button>
        `;
        grid.appendChild(el);
        if(p.stock>0){
          document.getElementById(`add-${p.id}`).addEventListener('click', ()=> addToCart(p.id));
        }
      }
    }

    function addToCart(id){
      const prod = products.find(x=>x.id===id);
      if(!prod || prod.stock===0){ alert('Not available'); return; }
      const item = cart.find(c=>c.id===id);
      if(item){
        if(item.qty+1 > prod.stock){ alert('Not enough stock'); return;}
        item.qty++;
      } else cart.push({id:id, name:prod.name, price_cents: prod.price_cents, qty:1});
      renderCart();
    }

    function renderCart(){
      const box = document.getElementById('cartitems');
      box.innerHTML = '';
      let totalCents = 0;
      for(const it of cart){
        totalCents += it.price_cents * it.qty;
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `${it.name} x ${it.qty} — $${(it.price_cents/100).toFixed(2)} each
          <button onclick="dec(${it.id})">-</button>
          <button onclick="inc(${it.id})">+</button>`;
        box.appendChild(div);
      }
      document.getElementById('total').innerText = 'Total: $' + (totalCents/100).toFixed(2);
    }

    function inc(id){
      const it=cart.find(c=>c.id===id); 
      const p=products.find(x=>x.id===id); 
      if(it.qty+1>p.stock){alert('No more stock');return;} 
      it.qty++; renderCart();
    }
    function dec(id){ 
      const it=cart.find(c=>c.id===id); 
      if(!it)return; 
      it.qty--; 
      if(it.qty<=0) cart.splice(cart.indexOf(it),1); 
      renderCart(); 
    }

    // PayPal Smart Buttons integration
    paypal.Buttons({
      createOrder: async () => {
        if(cart.length===0){ alert("Cart empty"); throw new Error("Cart empty"); }
        const cartForServer = cart.map(i=>({id:i.id, qty:i.qty}));
        const res = await fetch('/api/create-order', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({cart: cartForServer, currency:'USD'})
        });
        const orderData = await res.json();
        if(!res.ok){ alert("Error creating order"); throw new Error(orderData.error); }
        return orderData.id;
      },
      onApprove: async (data) => {
        const cartForServer = cart.map(i=>({id:i.id, qty:i.qty}));
        const res = await fetch('/api/capture-order', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({orderID: data.orderID, cart: cartForServer})
        });
        const capData = await res.json();
        if(res.ok){
          alert("Payment successful! Thank you.");
          cart.length = 0;
          renderCart();
          load(); // refresh stock
        } else {
          alert("Capture failed: " + capData.error);
        }
      },
      onError: (err) => {
        console.error(err);
        alert("PayPal error: " + err.message);
      }
    }).render('#paypal-button-container');

    window.inc = inc; 
    window.dec = dec;

    load();
  </script>
</body>
</html>
