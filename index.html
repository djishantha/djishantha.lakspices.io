<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LAKSPICES LLC — Shop</title>
  <style>
    :root { --card-pad:12px; --cols:4; --page-width:1200px; }
    body { font-family:Inter, system-ui, Arial, sans-serif; margin:20px; display:flex; justify-content:center; }
    .wrap { max-width:var(--page-width); width:100%; }
    header { display:flex; align-items:center; justify-content:space-between; }
    h1 { margin:0 0 12px 0; font-size:24px; }
    .controls { display:flex; gap:8px; align-items:center; }
    .grid { display:grid; grid-template-columns: repeat(var(--cols), 1fr); gap:16px; margin-top:18px; }
    .card { border:1px solid #e6e6e6;border-radius:8px;padding:var(--card-pad); background:#fff; display:flex;flex-direction:column; height:100%; }
    .card img { width:100%; height:160px; object-fit:cover; border-radius:6px; }
    .meta { margin-top:8px; flex:1; }
    .title { font-weight:700; }
    .desc { font-size:13px; color:#444; margin-top:6px; }
    .price { font-weight:800; margin-top:8px; }
    .stock { margin-top:6px; }
    .notavail { color:#b00000; font-weight:700; }
    .card-footer { display:flex; gap:8px; align-items:center; margin-top:10px; }
    button { cursor:pointer; padding:8px 10px; border-radius:6px; border:1px solid #ccc; background:#f7f7f7; }
    button.primary { background:#1a73e8; color:white; border-color:#1669c1; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    .cart { position:fixed; right:20px; top:20px; width:300px; border:1px solid #e6e6e6; padding:12px; background:white; border-radius:8px; box-shadow:0 4px 14px rgba(0,0,0,0.06); }
    .cart h3 { margin:0 0 8px 0; }
    .cart-list { max-height:330px; overflow:auto; margin-bottom:8px; }
    .cart-item { display:flex; justify-content:space-between; gap:8px; align-items:center; padding:6px 0; border-bottom:1px dashed #eee; }
    .small { font-size:13px; color:#555; }
    .pager { margin-top:18px; display:flex; gap:8px; align-items:center; justify-content:center; }
    .footer-note { margin-top:14px; font-size:13px; color:#666; }
    .page-size { width:70px; }
    @media (max-width:1000px) {
      .grid { grid-template-columns: repeat(2,1fr); }
      .cart { position:static; width:auto; margin-top:12px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>LAKSPICES LLC — Spices Store</h1>
        <div class="footer-note">Grid: 4 items per row. Adjust rows/page below.</div>
      </div>

      <div class="controls">
        <label class="small">Rows per page:
          <select id="rowsPerPage">
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="25" selected>25</option>
            <option value="50">50</option>
          </select>
        </label>

        <label class="small">Search:
          <input id="search" placeholder="name or desc" />
        </label>

        <div id="cartCount" class="small"></div>

        <a href="admin.html"><button>Admin</button></a>
      </div>
    </header>

    <main>
      <div id="grid" class="grid" aria-live="polite"></div>
      <div class="pager" id="pager">
        <button id="prev">Prev</button>
        <div id="pageInfo" class="small"></div>
        <button id="next">Next</button>
      </div>
    </main>

    <div class="cart" id="cart">
      <h3>Cart</h3>
      <div class="cart-list" id="cartList"></div>
      <div id="total" class="small" style="font-weight:800;margin-bottom:8px"></div>
      <div id="paypal-buttons"></div>
      <div style="margin-top:8px; display:flex; gap:8px;">
        <button id="clearCart">Clear</button>
        <button id="exportCart">Export Order</button>
      </div>
      <div class="footer-note" style="margin-top:10px;">
        Note: This demo uses client-side PayPal for testing only. For production, implement server-side order creation & webhooks.
      </div>
    </div>
  </div>

<script>
const PAYPAL_CLIENT_ID = 'AXUZYpgdB2oGgzp-3hGfnY5e_Qyuqs1tokPRfPpKLehbLXRXo6PBzvnxdKJiAL3z97c46aVOk-s2yMkT';
const PRODUCTS_FILE = './products.json';
const COLS = 4;
let products = [];
let filtered = [];
let page = 1;
let rows = 25;
let cart = loadCart();

document.getElementById('rowsPerPage').value = rows;
document.getElementById('rowsPerPage').addEventListener('change', e=>{
  rows = parseInt(e.target.value,10); page = 1; render();
});
document.getElementById('search').addEventListener('input', ()=>{ page = 1; render(); });
document.getElementById('prev').addEventListener('click', ()=>{ if(page>1) page--; render(); });
document.getElementById('next').addEventListener('click', ()=>{ page++; render(); });
document.getElementById('clearCart').addEventListener('click', ()=>{ cart = []; saveCart(); renderCart(); });
document.getElementById('exportCart').addEventListener('click', exportOrder);

fetchProducts();

async function fetchProducts(){
  try{
    const res = await fetch(PRODUCTS_FILE, {cache:'no-cache'});
    if(!res.ok) throw new Error('products.json not found');
    products = await res.json();
    afterProductsLoad();
  }catch(err){
    console.error('Failed to load products.json', err);
    products = [];
    afterProductsLoad();
  }
}

function afterProductsLoad(){
  filtered = products.slice();
  render();
  renderCart();
  renderPayPalButtons();
}

function searchFilter(){
  const q = document.getElementById('search').value.trim().toLowerCase();
  if(!q) filtered = products.slice();
  else filtered = products.filter(p=> (p.name||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q) || (p.sku||'').toLowerCase().includes(q));
}

function render(){
  searchFilter();
  const perPage = rows * COLS;
  const start = (page-1) * perPage;
  const pageItems = filtered.slice(start, start + perPage);
  const maxPage = Math.max(1, Math.ceil(filtered.length / perPage));
  if(page > maxPage) page = maxPage;

  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  for(const p of pageItems){
    const card = document.createElement('div'); card.className = 'card';
    card.innerHTML = `
      <img loading="lazy" src="${p.image_url || 'https://via.placeholder.com/400x260?text=No+Image'}" alt="${escapeHtml(p.name||'')}">
      <div class="meta">
        <div class="title">${escapeHtml(p.name||'Unnamed')}</div>
        <div class="desc">${escapeHtml(p.description||'')}</div>
        <div class="price">$${(p.price_cents/100).toFixed(2)}</div>
        <div class="stock">${p.stock>0 ? `${p.stock} in stock` : `<span class="notavail">Out of stock</span>`}</div>
      </div>
      <div class="card-footer">
        <button ${p.stock<=0?'disabled':''} class="primary" id="add-${p.id}">Add to cart</button>
      </div>
    `;
    grid.appendChild(card);

    if(p.stock>0) document.getElementById(`add-${p.id}`).addEventListener('click', ()=> addToCart(p.id));
  }

  document.getElementById('pageInfo').textContent = `Page ${page} of ${maxPage}`;
}

function addToCart(id){
  const p = products.find(x=>x.id===id);
  if(!p) return alert('Product not found');
  if(p.stock <= 0) return alert('Product not available');

  const it = cart.find(c=>c.id===id);
  if(it){
    if(it.qty + 1 > p.stock) return alert('Not enough stock');
    it.qty++;
  } else {
    cart.push({id:id, name:p.name, price_cents:p.price_cents, qty:1});
  }

  saveCart();
  renderCart();
  document.getElementById('cart').scrollIntoView({behavior:'smooth'});
}

function renderCart(){
  const elm = document.getElementById('cartList'); elm.innerHTML = '';
  let totalCents = 0;
  for(const it of cart){
    const row = document.createElement('div'); row.className='cart-item';
    const p = products.find(x=>x.id===it.id) || {};
    totalCents += (it.price_cents||p.price_cents||0) * it.qty;
    row.innerHTML = `
      <div style="flex:1">
        <div style="font-weight:700">${escapeHtml(it.name)}</div>
        <div class="small">${it.qty} × $${((it.price_cents||p.price_cents)/100).toFixed(2)}</div>
      </div>
      <div style="display:flex;flex-direction:column; gap:6px; align-items:flex-end;">
        <div style="display:flex; gap:6px;">
          <button onclick="decQty(${it.id})">-</button>
          <button onclick="incQty(${it.id})">+</button>
        </div>
        <button onclick="removeItem(${it.id})">Remove</button>
      </div>
    `;
    elm.appendChild(row);
  }

  document.getElementById('total').textContent = 'Total: $' + (totalCents/100).toFixed(2);
  document.getElementById('cartCount').textContent = `Items in cart: ${cart.reduce((sum,i)=>sum+i.qty,0)}`;
  renderPayPalButtons();
}

function incQty(id){
  const it = cart.find(x=>x.id===id);
  const p = products.find(x=>x.id===id);
  if(it && p && it.qty + 1 <= p.stock){ it.qty++; saveCart(); renderCart(); }
}

function decQty(id){
  const it = cart.find(x=>x.id===id);
  if(it && it.qty > 1){ it.qty--; saveCart(); renderCart(); }
}

function removeItem(id){ cart = cart.filter(x=>x.id!==id); saveCart(); renderCart(); }
function saveCart(){ localStorage.setItem('lakspices_cart', JSON.stringify(cart)); }
function loadCart(){ try{ return JSON.parse(localStorage.getItem('lakspices_cart')) || []; }catch(e){ return []; } }

function exportOrder(){
  if(cart.length === 0) return alert('Cart is empty');
  const lines = ['Name,Quantity,Price'];
  for(const it of cart){
    lines.push(`"${it.name}",${it.qty},${(it.price_cents/100).toFixed(2)}`);
  }
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'order.csv'; a.click(); URL.revokeObjectURL(url);
}

function renderPayPalButtons(){
  const container = document.getElementById('paypal-buttons');
  container.innerHTML = '';
  if(!PAYPAL_CLIENT_ID) {
    container.innerHTML = '<div class="small" style="color:#a00">Missing PayPal Client ID.</div>';
    return;
  }
  if(!window.paypal){
    const script = document.createElement('script');
    script.src = `https://www.paypal.com/sdk/js?client-id=${PAYPAL_CLIENT_ID}&currency=USD`;
    script.onload = () => renderPayPalButtons();
    document.head.appendChild(script);
    return;
  }
  const items = cart.map(it=>{
    const p = products.find(x=>x.id===it.id) || {};
    return {
      name: p.name || it.name,
      unit_amount: { currency_code: 'USD', value: ((it.price_cents||p.price_cents)/100).toFixed(2) },
      quantity: String(it.qty),
      sku: p.sku || String(it.id)
    };
  });
  const total = items.reduce((s,i)=> s + (parseFloat(i.unit_amount.value) * parseInt(i.quantity)), 0).toFixed(2);
  window.paypal.Buttons({
    style:{layout:'vertical', color:'gold', shape:'rect', label:'paypal'},
    createOrder: (data, actions)=>{
      if(cart.length===0) return alert('Cart is empty');
      return actions.order.create({
        purchase_units: [{
          amount: {
            currency_code: 'USD',
            value: total,
            breakdown: { item_total: { currency_code: 'USD', value: total } }
          },
          items
        }]
      });
    },
    onApprove: (data, actions)=>{
      return actions.order.capture().then(function(details){
        for(const it of cart){
          const p = products.find(x=>x.id===it.id);
          if(p) p.stock = Math.max(0, p.stock - it.qty);
        }
        localStorage.setItem('lakspices_products', JSON.stringify(products));
        cart = [];
        saveCart(); render(); renderCart();
        alert('Payment successful — Transaction ID: ' + (details.id || 'unknown'));
      });
    },
    onError: err=>{ console.error('PayPal error', err); alert('PayPal error: '+err); }
  }).render('#paypal-buttons');
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s]);
}
</script>
</body>
</html>
